<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • maskedhaz</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">maskedhaz</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/queelius/maskedhaz"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>CLAUDE.md</h1>
      <small class="dont-index">Source: <a href="https://github.com/queelius/maskedhaz/blob/HEAD/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><code>maskedhaz</code> provides likelihood-based inference for series systems with masked component cause of failure, using arbitrary dynamic failure rate (DFR) component distributions. Given series system data where the causing component is uncertain (masked), it computes log-likelihood, score, Hessian, and MLE for the component parameters.</p>
<p>The package decouples from closed-form assumptions: any <code>dfr_dist</code> component distribution works, with numerical integration for censored observations and <code>numDeriv</code> for derivatives.</p>
</div>
<div class="section level2">
<h2 id="development-commands">Development Commands<a class="anchor" aria-label="anchor" href="#development-commands"></a></h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">document</a></span><span class="op">(</span><span class="op">)</span>      <span class="co"># Update NAMESPACE and .Rd files from roxygen2</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span>          <span class="co"># Run all tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="st">"loglik"</span><span class="op">)</span>   <span class="co"># Run specific test file</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/check.html" class="external-link">check</a></span><span class="op">(</span><span class="op">)</span>         <span class="co"># Run R CMD check</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="op">)</span>       <span class="co"># Install locally</span></span>
<span><span class="fu">covr</span><span class="fu">::</span><span class="fu"><a href="http://covr.r-lib.org/reference/package_coverage.html" class="external-link">package_coverage</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Check test coverage (target &gt;= 97%)</span></span></code></pre></div>
<p>Always run <code><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">devtools::document()</a></code> after modifying roxygen2 comments. NAMESPACE is auto-generated — never edit manually.</p>
</div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h2>
<p><strong>Required (Imports):</strong> - <code>serieshaz</code> — Series system distributions (Phase 1) - <code>flexhaz</code> — DFR component distributions and constructors - <code>algebraic.dist</code> — Distribution interface generics - <code>likelihood.model</code> — Likelihood model interface + <code>fisher_mle</code> class - <code>generics</code> — Generic function infrastructure (<code>fit</code>) - <code>numDeriv</code> — Numerical score and Hessian - <code>stats</code> — <code>integrate</code>, <code>optim</code>, <code>runif</code></p>
<p><strong>Optional (Suggests):</strong> - <code>maskedcauses</code> — Cross-validation against closed-form exponential/Weibull - <code>testthat</code>, <code>knitr</code>, <code>rmarkdown</code></p>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="the-dfr_series_md-object">The <code>dfr_series_md</code> Object<a class="anchor" aria-label="anchor" href="#the-dfr_series_md-object"></a></h3>
<p>Constructor in <code>R/dfr_series_md.R</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/dfr_series_md.html">dfr_series_md</a></span><span class="op">(</span>series <span class="op">=</span> <span class="cn">NULL</span>, components <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>              par <span class="op">=</span> <span class="cn">NULL</span>, n_par <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>              lifetime <span class="op">=</span> <span class="st">"t"</span>, lifetime_upper <span class="op">=</span> <span class="st">"t_upper"</span>,</span>
<span>              omega <span class="op">=</span> <span class="st">"omega"</span>, candset <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span></code></pre></div>
<p>Class hierarchy: <code>c("dfr_series_md", "series_md", "likelihood_model")</code></p>
<p>Stores a <code>dfr_dist_series</code> object (from Phase 1) plus column name configuration for data frames.</p>
</div>
<div class="section level3">
<h3 id="data-convention">Data Convention<a class="anchor" aria-label="anchor" href="#data-convention"></a></h3>
<p>Uses <code>omega</code> column (string), NOT numeric <code>delta</code>:</p>
<table class="table"><thead><tr class="header"><th>
<code>omega</code> value</th>
<th>Meaning</th>
<th>Columns used</th>
</tr></thead><tbody><tr class="odd"><td><code>"exact"</code></td>
<td>Failed at time t, cause masked</td>
<td>
<code>t</code>, <code>x1..xm</code>
</td>
</tr><tr class="even"><td><code>"right"</code></td>
<td>Right-censored at t</td>
<td><code>t</code></td>
</tr><tr class="odd"><td><code>"left"</code></td>
<td>Left-censored: failed before t</td>
<td>
<code>t</code>, <code>x1..xm</code>
</td>
</tr><tr class="even"><td><code>"interval"</code></td>
<td>Failed in (t, t_upper)</td>
<td>
<code>t</code>, <code>t_upper</code>, <code>x1..xm</code>
</td>
</tr></tbody></table><p>Candidate sets: Boolean columns <code>x1, x2, ..., xm</code> (TRUE = component j is a candidate cause).</p>
</div>
<div class="section level3">
<h3 id="closure-returning-pattern">Closure-Returning Pattern<a class="anchor" aria-label="anchor" href="#closure-returning-pattern"></a></h3>
<p>All methods follow the two-step pattern from <code>flexhaz</code>: 1. Call method on model → returns closure 2. Call closure with data and parameters</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dfr_series_md.html">dfr_series_md</a></span><span class="op">(</span>components <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://queelius.github.io/flexhaz/reference/dfr_exponential.html" class="external-link">dfr_exponential</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://queelius.github.io/flexhaz/reference/dfr_exponential.html" class="external-link">dfr_exponential</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ll_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://queelius.github.io/likelihood.model/reference/loglik.html" class="external-link">loglik</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>         <span class="co"># returns closure</span></span>
<span><span class="fu">ll_fn</span><span class="op">(</span><span class="va">df</span>, par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>  <span class="co"># evaluates log-likelihood</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="log-likelihood-computation">Log-Likelihood Computation<a class="anchor" aria-label="anchor" href="#log-likelihood-computation"></a></h3>
<p><strong>Exact + right-censored</strong> (fast path): Direct hazard/cum_haz calls, no integration. - Exact: <code>log(sum_{j in C_i} h_j(t_i)) - H_sys(t_i)</code> - Right: <code>-H_sys(t_i)</code></p>
<p><strong>Left + interval-censored</strong> (integration path): Uses <code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">stats::integrate()</a></code> per observation. - Integrates <code>[sum_{j in C_i} h_j(t)] * S_sys(t)</code> over the relevant interval.</p>
</div>
<div class="section level3">
<h3 id="score-and-hessian">Score and Hessian<a class="anchor" aria-label="anchor" href="#score-and-hessian"></a></h3>
<p>Always uses <code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">numDeriv::grad()</a></code> and <code><a href="https://rdrr.io/pkg/numDeriv/man/hessian.html" class="external-link">numDeriv::hessian()</a></code> on the log-likelihood. No analytical derivatives in this package — that complexity is deferred to component-level <code>dfr_dist</code> objects.</p>
</div>
<div class="section level3">
<h3 id="mle-fitting">MLE Fitting<a class="anchor" aria-label="anchor" href="#mle-fitting"></a></h3>
<p><code>fit.dfr_series_md</code> uses <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> with numerical score. Returns a <code>fisher_mle</code> object with standard methods: <code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code>, <code><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov()</a></code>, <code><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik()</a></code>, <code><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint()</a></code>, <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>.</p>
<p>Auto-switches from Nelder-Mead to BFGS for single-parameter models.</p>
</div>
</div>
<div class="section level2">
<h2 id="source-file-organization">Source File Organization<a class="anchor" aria-label="anchor" href="#source-file-organization"></a></h2>
<ul><li>
<code>R/dfr_series_md.R</code> — Constructor, type predicate, print method</li>
<li>
<code>R/loglik.R</code> — <code>loglik.dfr_series_md</code> + <code>censored_integral</code> helper</li>
<li>
<code>R/score_hess.R</code> — <code>score.dfr_series_md</code>, <code>hess_loglik.dfr_series_md</code> (numDeriv)</li>
<li>
<code>R/fit.R</code> — <code>fit.dfr_series_md</code> (optim → fisher_mle)</li>
<li>
<code>R/rdata.R</code> — <code>rdata.dfr_series_md</code> (data generation)</li>
<li>
<code>R/methods.R</code> — <code>assumptions</code>, <code>ncomponents</code>, <code>component_hazard</code>, <code>conditional_cause_probability</code>, <code>cause_probability</code>
</li>
<li>
<code>R/utils.R</code> — <code>decode_candidate_matrix</code>, <code>extract_md_data</code>, <code>generate_masked_series_data</code>
</li>
<li>
<code>R/reexports.R</code> — Re-exports from dependency packages</li>
</ul></div>
<div class="section level2">
<h2 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h2>
<p>Tests in <code>tests/testthat/</code> (10 files): - <code>helper-fixtures.R</code> — Shared helpers (<code>make_exp_model</code>, <code>make_weibull_model</code>, <code>exp_series_loglik_analytical</code>) - <code>test-constructor.R</code> — Class hierarchy, validation, print - <code>test-loglik.R</code> — Finite values, analytical match, monotonicity - <code>test-score-hess.R</code> — Dimensions, near-zero at MLE, negative definite Hessian - <code>test-fit.R</code> — Parameter recovery, convergence, fisher_mle methods - <code>test-rdata.R</code> — Data structure, censoring, masking, custom columns - <code>test-censoring.R</code> — Left/interval/right contributions, analytical match - <code>test-cross-validate.R</code> — Against <code>maskedcauses</code> (skipped if not installed) - <code>test-methods.R</code> — assumptions, ncomponents, conditional/marginal cause probabilities - <code>test-utils.R</code> — decode_candidate_matrix, extract_md_data, generate_masked_series_data</p>
<div class="section level3">
<h3 id="key-identifiability-constraint">Key Identifiability Constraint<a class="anchor" aria-label="anchor" href="#key-identifiability-constraint"></a></h3>
<p>Exponential series systems are <strong>not identifiable</strong> for individual rates from system-level masked data alone — only the sum of rates is identifiable. Tests account for this by checking <code>sum(coef(result))</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="masking-conditions-c1-c2-c3">Masking Conditions (C1-C2-C3)<a class="anchor" aria-label="anchor" href="#masking-conditions-c1-c2-c3"></a></h2>
<ul><li>
<strong>C1</strong>: The failed component is always in the candidate set</li>
<li>
<strong>C2</strong>: Candidate sets are generated uniformly given the failed component</li>
<li>
<strong>C3</strong>: Masking probabilities are independent of system parameters</li>
</ul><p>These conditions come from the foundational paper at <code>~/github/papers/masked-causes-in-series-systems/paper.tex</code> (Theorem 7).</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Towell.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

